---
import Layout from "../layouts/Layout.astro";
import UpdatePasswordForm from "../components/auth/UpdatePasswordForm";

export const prerender = false;

// Check if there's a token in the URL (from email link)
const token_hash = Astro.url.searchParams.get("token_hash");
const type = Astro.url.searchParams.get("type");

// If we have a token, verify it first to create a session
if (token_hash && type === "recovery") {
  const { error } = await Astro.locals.supabase.auth.verifyOtp({
    type: "recovery",
    token_hash,
  });

  if (error) {
    console.error("Token verification error:", error);
    return Astro.redirect(`/login?error=${encodeURIComponent("Link jest nieprawidłowy lub wygasł")}`);
  }

  // Token verified successfully - redirect to clean URL (without token params)
  return Astro.redirect("/update-password");
}

// Now check if user has an active session
const {
  data: { user },
} = await Astro.locals.supabase.auth.getUser();

if (!user) {
  return Astro.redirect(`/login?error=${encodeURIComponent("Brak sesji użytkownika")}`);
}
---

<Layout title="Zmiana hasła - WorkLog" showNav={false}>
  <main class="min-h-screen flex items-center justify-center px-4 py-8">
    <UpdatePasswordForm client:load />
  </main>
</Layout>
